<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>WaterHero 6.4 â€” æ¯æ—¥å–æ°´ç´€éŒ„ï¼ˆæ‰‹æ©Ÿå–®é ï¼‰</title>
<!-- Tailwind CDN for quick styling -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  /* Mobile-first clean layout */
  :root { -webkit-tap-highlight-color: transparent; }
  * { box-sizing: border-box; }
  html,body { height:100%; margin:0; padding:0; background: linear-gradient(180deg,#eef8ff,#ffffff); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Helvetica Neue", Arial; color:#0f172a; display:flex; justify-content:center; padding:16px 12px; }
  .app { width:100%; max-width:420px; }
  .glass { background:rgba(255,255,255,0.85); backdrop-filter: blur(6px); border-radius:14px; padding:14px; box-shadow:0 6px 20px rgba(14,30,37,0.06); }
  h1 { font-weight:700; color:#0ea5e9; }
  .progress { height:10px; background:#e6eef8; border-radius:999px; overflow:hidden; }
  .progress > .fill { height:100%; width:0%; background:linear-gradient(90deg,#38bdf8,#0ea5e9); transition:width 400ms ease; }
  .water-bucket { width:72px; height:140px; border-radius:8px 8px 20px 20px; position:relative; overflow:hidden; margin:0 auto; }
  .bucket-outline { position:absolute; inset:0; border:5px solid #9aa6b2; border-top-width:10px; border-radius:8px 8px 20px 20px; pointer-events:none; box-sizing:border-box; }
  .water-level { position:absolute; left:0; bottom:0; width:100%; height:0%; background:linear-gradient(180deg,#60a5fa,#93c5fd); transition:height .7s ease; border-radius:0 0 14px 14px; }
  .flower-garden { display:flex; flex-wrap:wrap; gap:6px; padding:6px; min-height:80px; max-height:150px; overflow:auto; border-radius:10px; border:1px dashed #cde7ff; background:#fbffff; align-items:flex-end; justify-content:center; }
  .flower { font-size:1.5rem; transform-origin:center bottom; transition: transform .25s ease; }
  .btn-row { display:flex; gap:8px; flex-wrap:wrap; }
  .btn-row button { flex:1 1 0; padding:10px 12px; border-radius:10px; font-weight:600; }
  .small { font-size:.9rem; color:#475569; }
  canvas { display:block; width:100% !important; height:160px !important; }

  /* responsive tweaks */
  @media (min-width:600px) { .app { padding:12px; } }
</style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-xl">WaterHero v6.4</h1>
        <div class="small">æ‰‹æ©Ÿå–®é  â€¢ æœ¬æ©Ÿå„²å­˜ â€¢ åŠŸèƒ½å®Œæ•´</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="notifyBtn" class="glass px-3 py-2 rounded-lg text-sm">æé†’</button>
      </div>
    </header>

    <main class="space-y-4">
      <!-- Today summary & input -->
      <section class="glass">
        <div class="flex justify-between items-center mb-3">
          <div>
            <div class="small">ä»Šæ—¥ç›®æ¨™</div>
            <div class="text-lg font-bold"><span id="goalDisplay">2000</span> ml</div>
          </div>
          <div class="text-right">
            <div class="small">å·²å–</div>
            <div class="text-lg font-bold"><span id="todayTotal">0</span> ml</div>
          </div>
        </div>

        <div class="text-center mb-3 small">ä¸‹æ¬¡æé†’å€’æ•¸: <span id="timerDisplay" class="font-medium">--:--:--</span></div>

        <div class="progress mb-3" aria-hidden="true"><div id="progressFill" class="fill"></div></div>

        <div class="flex gap-2 mb-3">
          <input id="addInput" type="number" inputmode="numeric" placeholder="è¼¸å…¥å–æ°´é‡ï¼ˆä¾‹å¦‚ 250ï¼‰" class="flex-1 border rounded-lg px-3 py-2" />
          <select id="unitSelect" class="border rounded-lg px-3 py-2">
            <option value="ml">ml</option>
            <option value="cup">æ¯ï¼ˆ250mlï¼‰</option>
          </select>
        </div>

        <div class="btn-row">
          <button id="addBtn" class="bg-sky-500 text-white">åŠ å…¥</button>
          <button id="undoBtn" class="bg-red-500 text-white">æ’¤éŠ·</button>
          <button id="resetToday" class="bg-amber-400 text-white">é‡è¨­ä»Šæ—¥</button>
          <button id="resetAll" class="bg-gray-700 text-white">é‡è¨­å…¨éƒ¨</button>
        </div>
      </section>

      <!-- Flower area -->
      <section class="glass">
        <h3 class="text-base font-semibold text-center mb-3">ğŸ’§ æ¾†èŠ±æŒ‘æˆ°ï¼ˆç´¯ç© 1000mlï¼‰</h3>
        <div class="flex items-end gap-4">
          <div class="water-bucket">
            <div id="waterLevel" class="water-level" style="height:0%"></div>
            <div class="bucket-outline" aria-hidden="true"></div>
          </div>

          <div class="flex-1">
            <div id="flowerGarden" class="flower-garden"><div id="gardenMessage" class="small">ä½ çš„èŠ±åœ’é‚„ç©ºç©ºçš„ï¼Œé–‹å§‹å–æ°´å§ã€‚</div></div>
            <div class="mt-2">
              <button id="waterFlower" class="w-full py-2 rounded-lg bg-green-600 text-white" disabled>æ¾†èŠ± (1000 ml)</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Bottle & badges -->
      <section class="glass">
        <div class="flex items-center justify-between mb-3">
          <div>
            <div class="small">æ°´ç“¶åç¨±</div>
            <input id="bottleName" class="border rounded-lg px-3 py-2 mt-1" placeholder="ç‚ºä½ çš„æ°´ç“¶å‘½åï¼ˆè¼¸å…¥å¾ŒæŒ‰ç¢ºå®šï¼‰" />
          </div>
          <div class="text-right">
            <div class="small">ç­‰ç´š</div>
            <div id="bottleLevel" class="text-lg font-bold">Lv.1</div>
          </div>
        </div>
        <div class="flex gap-2 mb-3">
          <button id="bottleConfirm" class="flex-1 bg-sky-600 text-white py-2 rounded-lg">ç¢ºå®š</button>
          <button id="claimBadge" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg">é ˜å–å¾½ç« </button>
        </div>

        <div class="small mb-2">é€£çºŒé”æ¨™ (streak): <span id="streakCount">0</span></div>
        <div id="badgeContainer" class="flex flex-wrap gap-2"></div>
      </section>

      <!-- Charts -->
      <section class="glass">
        <h3 class="text-base font-semibold mb-2">ğŸ“Š ä»Šæ—¥å–æ°´åˆ†å¸ƒ</h3>
        <canvas id="todayChart"></canvas>
      </section>

      <section class="glass">
        <h3 class="text-base font-semibold mb-2">ğŸ“ˆ éå» 7 å¤©è¨˜éŒ„</h3>
        <canvas id="weekChart"></canvas>
        <div id="historyList" class="mt-3 small text-slate-600"></div>
      </section>

      <!-- Settings -->
      <section class="glass">
        <h3 class="small font-semibold mb-2">ç³»çµ±è¨­å®š</h3>
        <div class="flex items-center gap-2 mb-3">
          <div class="basis-[150px] shrink-0">
            <div class="small">æ¯æ—¥ç›®æ¨™ (ml)</div>
            <input id="goalInput" type="number" min="100" class="border rounded-lg px-2 py-2 mt-1 w-full" value="2000">
          </div>
         <div class="flex-1">
            <div class="small">æé†’ (åˆ†é˜)</div>
            <input id="reminderMinutes" type="number" min="10" class="border rounded-lg px-3 py-2 mt-1 w-full" value="120">
          </div>
        </div>
        <div class="flex gap-2">
          <button id="saveSettings" class="flex-1 bg-green-600 text-white py-2 rounded-lg">å„²å­˜è¨­å®š</button>
          <button id="exportBtn" class="flex-1 bg-slate-600 text-white py-2 rounded-lg">åŒ¯å‡ºè³‡æ–™</button>
        </div>
        <div class="small mt-2 text-slate-600">èªªæ˜ï¼šæé†’éœ€å…è¨±ç€è¦½å™¨é€šçŸ¥ï¼›è³‡æ–™å„²å­˜åœ¨æœ¬æ©Ÿ localStorageï¼Œä¸æœƒä¸Šå‚³ã€‚</div>
      </section>
    </main>

    <footer class="text-center small text-slate-400 mt-4">Â© 2025 WaterHero</footer>
  </div>

<script>
/* =========================
   WaterHero v3.6 - client only
   ========================= */

const LS_KEY = 'waterhero_v3.6';
const WATER_FOR_FLOWER = 1000;
const MILLI_PER_DAY = 24*3600*1000;

/* ---------- default state ---------- */
function defaultState(){
  return {
    settings: { goal:2000, unit:'ml', reminderMinutes:120, theme:'light' },
    meta: {
      dailyIntakes: {}, // { "YYYY-MM-DD": [ {amount, ts} ] }
      bucketAmount: 0,
      flowerGarden: [], // array of {date, ts}
      streak: 0,
      lastAchieved: null,
      level: 1,
      xp: 0,
      badges: [], // strings
      bottleName: '',
      lastIntake: null, // {date, amount, ts}
      lastReminderTime: Date.now()
    }
  };
}

/* ---------- persistence ---------- */
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return defaultState();
    const parsed = JSON.parse(raw);
    // safety defaults
    if(!parsed.meta) parsed.meta = defaultState().meta;
    if(!parsed.settings) parsed.settings = defaultState().settings;
    return {...defaultState(), ...parsed};
  }catch(e){
    console.warn('load fail', e);
    return defaultState();
  }
}
function saveState(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  catch(e){ console.warn('save fail', e); }
}

/* ---------- app state ---------- */
let state = loadState();

/* ---------- DOM refs ---------- */
const goalDisplay = document.getElementById('goalDisplay');
const todayTotalEl = document.getElementById('todayTotal');
const progressFill = document.getElementById('progressFill');
const addInput = document.getElementById('addInput');
const addBtn = document.getElementById('addBtn');
const undoBtn = document.getElementById('undoBtn');
const unitSelect = document.getElementById('unitSelect');
const resetToday = document.getElementById('resetToday');
const resetAll = document.getElementById('resetAll');
const waterLevel = document.getElementById('waterLevel');
const waterFlowerBtn = document.getElementById('waterFlower');
const flowerGarden = document.getElementById('flowerGarden');
const gardenMessage = document.getElementById('gardenMessage');
const bottleNameInput = document.getElementById('bottleName');
const bottleConfirm = document.getElementById('bottleConfirm');
const bottleLevelEl = document.getElementById('bottleLevel');
const streakCountEl = document.getElementById('streakCount');
const badgeContainer = document.getElementById('badgeContainer');
const claimBadgeBtn = document.getElementById('claimBadge');
const todayChartCtx = document.getElementById('todayChart').getContext('2d');
const weekChartCtx = document.getElementById('weekChart').getContext('2d');
const historyList = document.getElementById('historyList');
const notifyBtn = document.getElementById('notifyBtn');
const timerDisplay = document.getElementById('timerDisplay');
const saveSettingsBtn = document.getElementById('saveSettings');
const goalInput = document.getElementById('goalInput');
const reminderMinutesInput = document.getElementById('reminderMinutes');
const exportBtn = document.getElementById('exportBtn');

/* ---------- helper utils ---------- */
function isoDate(d = new Date()){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().split('T')[0]; }
function fmtTime(ts){ const d = new Date(ts); return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0'); }
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

/* ---------- chart setup ---------- */
const todayChart = new Chart(todayChartCtx, {
  type:'bar',
  data:{ labels:[], datasets:[{ label:'æ¯æ¬¡å–æ°´ (ml)', data:[], borderRadius:6, barPercentage:0.7 }]},
  options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ x:{grid:{display:false}}, y:{beginAtZero:true} } }
});
const weekChart = new Chart(weekChartCtx, {
  type:'bar',
  data:{ labels:[], datasets:[{ label:'æ¯æ—¥ç¸½é‡ (ml)', data:[], borderRadius:6, barPercentage:0.6, backgroundColor:'#60a5fa' }]},
  options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ x:{grid:{display:false}}, y:{beginAtZero:true} } }
});

/* ---------- core data helpers ---------- */
function getDailyList(dateKey){ return state.meta.dailyIntakes[dateKey] || []; }
function getTotalFor(dateKey){ return getDailyList(dateKey).reduce((s,r)=>s+r.amount, 0); }
function pushIntake(dateKey, amount){
  if(!state.meta.dailyIntakes[dateKey]) state.meta.dailyIntakes[dateKey] = [];
  const entry = { amount, ts: Date.now() };
  state.meta.dailyIntakes[dateKey].push(entry);
  state.meta.bucketAmount = (state.meta.bucketAmount || 0) + amount;
  state.meta.lastIntake = { date: dateKey, amount, ts: Date.now() };
  saveState();
}
function popLastIntake(dateKey){
  const arr = state.meta.dailyIntakes[dateKey] || [];
  if(arr.length === 0) return null;
  const last = arr.pop();
  state.meta.bucketAmount = Math.max(0, (state.meta.bucketAmount || 0) - last.amount);
  state.meta.lastIntake = null;
  saveState();
  return last;
}

/* ---------- achievement logic ---------- */
function awardDailyBadge(dateKey){
  const badgeId = `achieve-${dateKey}`;
  if(!state.meta.badges.includes(badgeId)){
    state.meta.badges.push(badgeId);
    // XP and streak handled in onAchieveToday
  }
}
function updateBottleLevelFromXp(){
  const xp = state.meta.xp || 0;
  // simple level curve: level = 1 + floor(xp / 3)
  const newLevel = Math.floor(xp / 3) + 1;
  state.meta.level = newLevel;
}

/* ---------- UI render ---------- */
function renderGarden(){
  const g = state.meta.flowerGarden || [];
  flowerGarden.innerHTML = '';
  if(g.length === 0){
    gardenMessage.style.display = 'block';
  } else {
    gardenMessage.style.display = 'none';
    g.forEach(()=> {
      const el = document.createElement('div');
      el.className = 'flower';
      el.textContent = 'ğŸŒ¸';
      flowerGarden.appendChild(el);
      // simple pop-in
      requestAnimationFrame(()=> el.style.transform = 'scale(1.05)');
      setTimeout(()=> el.style.transform = '', 260);
    });
  }
}

function renderBadges(){
  badgeContainer.innerHTML = '';
  (state.meta.badges || []).forEach(b => {
    const el = document.createElement('div');
    el.className = 'px-2 py-1 rounded bg-sky-100 text-sky-700 text-sm';
    el.textContent = b;
    badgeContainer.appendChild(el);
  });
}

function renderHistoryList(){
  const keys = Object.keys(state.meta.dailyIntakes).sort().slice(-14).reverse();
  if(keys.length === 0){
    historyList.innerHTML = '<div class="small text-slate-500">å°šç„¡ç´€éŒ„</div>';
    return;
  }
  let html = '';
  keys.forEach(k => {
    const total = getTotalFor(k);
    const details = (state.meta.dailyIntakes[k]||[]).map(it => it.amount).join(' + ');
    html += `<div class="py-2 border-b border-slate-100"><div class="flex justify-between font-semibold"><span>${k}</span><span>${total} ml</span></div><div class="small text-slate-500">è©³æƒ…: ${details} ml</div></div>`;
  });
  historyList.innerHTML = html;
}

function renderCharts(){
  // today chart: each intake's time and amount
  const todayKey = isoDate();
  const list = state.meta.dailyIntakes[todayKey] || [];
  todayChart.data.labels = list.map(it => {
    const d = new Date(it.ts);
    return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
  });
  todayChart.data.datasets[0].data = list.map(it => it.amount);
  todayChart.update();

  // week chart: 7 days totals
  const labels = [];
  const datapoints = [];
  for(let i=6;i>=0;i--){
    const d = new Date(Date.now() - i*MILLI_PER_DAY);
    const k = isoDate(d);
    labels.push(k.slice(5));
    datapoints.push(getTotalFor(k));
  }
  weekChart.data.labels = labels;
  weekChart.data.datasets[0].data = datapoints;
  weekChart.update();
}

function renderMain(){
  // goal & totals
  goalDisplay.textContent = state.settings.goal;
  const todayKeyStr = isoDate();
  const todayTotal = getTotalFor(todayKeyStr);
  todayTotalEl.textContent = Math.round(todayTotal);
  // progress
  const pct = clamp(Math.round(todayTotal / state.settings.goal * 100), 0, 100);
  progressFill.style.width = pct + '%';
  // bucket water level (we store bucketAmount in ml)
  const maxCap = WATER_FOR_FLOWER * 2;
  const levelPct = clamp(Math.round(state.meta.bucketAmount / maxCap * 100), 0, 100);
  waterLevel.style.height = levelPct + '%';

  // enable/disable flower
  waterFlowerBtn.disabled = (state.meta.bucketAmount < WATER_FOR_FLOWER);

  // bottle, streak, badges
  bottleLevelEl.textContent = 'Lv.' + (state.meta.level || 1);
  streakCountEl.textContent = state.meta.streak || 0;
  bottleNameInput.value = state.meta.bottleName || '';

  renderGarden();
  renderBadges();
  renderHistoryList();
  renderCharts();
  saveState();
}

/* ---------- actions ---------- */
function onAdd(){
  const raw = parseFloat(addInput.value);
  if(!raw || raw <= 0){ alert('è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æ•¸å­—'); return; }
  let addMl = raw;
  if(unitSelect && unitSelect.value === 'cup') addMl = raw * 250;
  const key = isoDate();
  pushIntake(key, addMl);
  addInput.value = '';
  // check achieve
  const prev = getTotalFor(key) - addMl;
  const now = getTotalFor(key);
  if(prev < state.settings.goal && now >= state.settings.goal){
    // achieved today
    onAchieveToday();
  }
  state.meta.lastReminderTime = Date.now();
  renderMain();
}

function onUndo(){
  const last = state.meta.lastIntake;
  if(!last){ alert('ç„¡å¯æ’¤éŠ·çš„è¨˜éŒ„'); return; }
  if(last.date !== isoDate()){ alert('åªèƒ½æ’¤éŠ·ä»Šæ—¥æœ€å¾Œä¸€ç­†'); return; }
  const todayArr = state.meta.dailyIntakes[last.date] || [];
  if(todayArr.length === 0 || todayArr[todayArr.length -1].amount !== last.amount){ alert('ç„¡æ³•æ’¤éŠ·ï¼šæœ€å¾Œç´€éŒ„ä¸ç¬¦'); return; }
  popLastIntake(last.date);
  renderMain();
}

function onWaterFlowerAction(){
  if(state.meta.bucketAmount < WATER_FOR_FLOWER){ alert('æ°´æ¡¶æ°´é‡ä¸è¶³ï¼Œç„¡æ³•æ¾†èŠ±'); return; }
  state.meta.bucketAmount -= WATER_FOR_FLOWER;
  state.meta.flowerGarden.push({ date: isoDate(), ts: Date.now() });
  saveState();
  renderMain();
  // brief toast
  toast('æ¾†èŠ±æˆåŠŸï¼ğŸŒ¸');
}

function onAchieveToday(){
  const yesterday = isoDate(new Date(Date.now() - MILLI_PER_DAY));
  const yesterdayReached = getTotalFor(yesterday) >= state.settings.goal;
  if(yesterdayReached && state.meta.lastAchieved === yesterday){
    state.meta.streak = (state.meta.streak || 0) + 1;
  } else {
    state.meta.streak = 1;
  }
  state.meta.lastAchieved = isoDate();
  // XP policy: æ¯æ¬¡é”æ¨™ +1 XP
  state.meta.xp = (state.meta.xp || 0) + 1;
  updateBottleLevelFromXp();
  // award badge
  awardDailyBadge(isoDate());
  saveState();
  toast('ä»Šæ—¥ç›®æ¨™é”æˆï¼å¾½ç« å¯é ˜å–');
}

/* ---------- badge / claim ---------- */
function onClaimBadge(){
  const today = isoDate();
  if(getTotalFor(today) < state.settings.goal){ alert('å°šæœªé”æˆä»Šæ—¥ç›®æ¨™ï¼Œç„¡æ³•é ˜å–å¾½ç« '); return; }
  const id = `claim-${today}`;
  if(state.meta.badges.includes(id)){ alert('æœ¬æ—¥å¾½ç« å·²é ˜å–'); return; }
  state.meta.badges.push(id);
  saveState();
  renderMain();
  toast('å¾½ç« å·²é ˜å–ï¼Œå·²åŠ å…¥å¾½ç« ç‰†');
}

/* ---------- bottle name / confirm ---------- */
function onConfirmBottleName(){
  const v = bottleNameInput.value.trim();
  state.meta.bottleName = v;
  saveState();
  toast(v ? `æ°´ç“¶å‘½åç‚ºã€Œ${v}ã€` : 'å·²ç§»é™¤æ°´ç“¶åç¨±');
  renderMain();
}

/* ---------- settings ---------- */
function onSaveSettings(){
  const g = parseInt(goalInput.value) || 2000;
  const rm = parseInt(reminderMinutesInput.value) || 120;
  state.settings.goal = Math.max(100, g);
  state.settings.reminderMinutes = Math.max(10, rm);
  saveState();
  startCountdown(true);
  renderMain();
  toast('è¨­å®šå·²å„²å­˜');
}

/* ---------- reset / export ---------- */
function onResetToday(){
  if(!confirm('ç¢ºèªè¦é‡è¨­ä»Šæ—¥å–æ°´ç´€éŒ„ï¼Ÿæ­¤å‹•ä½œä¸å¯é‚„åŸã€‚')) return;
  const key = isoDate();
  state.meta.dailyIntakes[key] = [];
  state.meta.lastIntake = null;
  // Do not reset streak/xp unless full reset
  saveState();
  renderMain();
  toast('ä»Šæ—¥ç´€éŒ„å·²é‡è¨­');
}
function onResetAll(){
  if(!confirm('é‡è¨­æ‰€æœ‰è³‡æ–™ï¼ˆå« streakã€å¾½ç« ã€æ­·å²ã€èŠ±åœ’ï¼‰ï¼Ÿ')) return;
  const token = prompt('è¼¸å…¥ "yes" ä»¥ç¢ºèªé‡è¨­');
  if(token !== 'yes'){ toast('å·²å–æ¶ˆ'); return; }
  state = defaultState();
  saveState();
  location.reload();
}
function onExport(){
  const dataStr = JSON.stringify(state, null, 2);
  const blob = new Blob([dataStr], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `waterhero_export_${isoDate()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('è³‡æ–™å·²åŒ¯å‡º');
}

/* ---------- notifications / reminders ---------- */
let countdownInterval = null;
function startCountdown(force=false){
  if(countdownInterval && !force) return;
  if(countdownInterval) clearInterval(countdownInterval);
  const mins = parseInt(state.settings.reminderMinutes) || 120;
  // base time is lastReminderTime; if not set use now
  if(!state.meta.lastReminderTime) state.meta.lastReminderTime = Date.now();
  const target = state.meta.lastReminderTime + (mins * 60 * 1000);
  countdownInterval = setInterval(()=> {
    const remaining = target - Date.now();
    if(remaining <= 0){
      timerDisplay.textContent = 'å·²è¶…æ™‚';
      clearInterval(countdownInterval);
      // try show notification
      if('Notification' in window && Notification.permission === 'granted'){
        new Notification('WaterHero æé†’', { body: 'é‚„æ²’é”æˆä»Šæ—¥å–æ°´ç›®æ¨™ï¼Œå–ä¸€æ¯å§ï¼' });
      } else {
        // fallback toast
        toast('æé†’ï¼šè©²å–æ°´äº†ï¼');
      }
      return;
    }
    const sec = Math.floor(remaining/1000);
    const h = Math.floor(sec/3600); const m = Math.floor((sec%3600)/60); const s = sec%60;
    timerDisplay.textContent = (h>0 ? `${h}h ${m}m ${s}s` : `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`);
  }, 1000);
}
async function onRequestNotify(){
  if(!confirm(`ç¢ºèªè¦å•Ÿç”¨æé†’å—ï¼Ÿæé†’å°‡åœ¨æœ¬åˆ†é é–‹å•Ÿæ™‚ï¼Œæ¯éš” ${state.settings.reminderMinutes} åˆ†é˜é¡¯ç¤º`)) return;
  if(!('Notification' in window)){ alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥'); return; }
  const perm = await Notification.requestPermission();
  if(perm === 'granted'){
    state.meta.lastReminderTime = Date.now();
    saveState();
    startCountdown(true);
    toast('é€šçŸ¥æ¬Šé™å·²å…è¨±ï¼Œæé†’å·²å•Ÿç”¨');
  } else {
    alert('æœªå…è¨±é€šçŸ¥');
  }
}

/* ---------- small utilities ---------- */
function toast(msg){
  const container = document.getElementById('toast');
  const div = document.createElement('div');
  div.className = 'glass small px-3 py-2';
  div.style.display = 'inline-block';
  div.textContent = msg;
  container.appendChild(div);
  setTimeout(()=> div.remove(), 2200);
}

/* ---------- event bindings ---------- */
function bindEvents(){
  addBtn.addEventListener('click', onAdd);
  addInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') onAdd(); });
  undoBtn.addEventListener('click', onUndo);
  waterFlowerBtn.addEventListener('click', onWaterFlowerAction);
  bottleConfirm.addEventListener('click', onConfirmBottleName);
  claimBadgeBtn.addEventListener('click', onClaimBadge);
  resetToday.addEventListener('click', onResetToday);
  resetAll.addEventListener('click', onResetAll);
  saveSettingsBtn.addEventListener('click', onSaveSettings);
  exportBtn.addEventListener('click', onExport);
  notifyBtn.addEventListener('click', onRequestNotify);
  unitSelect.addEventListener('change', ()=>{ state.settings.unit = unitSelect.value; saveState(); });
}

/* ---------- initial sync ---------- */
function hydrateDefaults(){
  // push defaults to DOM inputs
  goalInput.value = state.settings.goal;
  reminderMinutesInput.value = state.settings.reminderMinutes;
  unitSelect.value = state.settings.unit || 'ml';
}

/* ---------- boot ---------- */
window.onload = () => {
  bindEvents();
  hydrateDefaults();
  renderMain();
  startCountdown(); // start countdown if applicable
};

</script>
</body>
</html>

















