<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WaterHero â€” æ¯æ—¥å–æ°´ç´€éŒ„ (çµ‚æ¥µä¿®å¾©ç‰ˆ)</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lottie-web@5.10.1/build/player/lottie.min.js"></script>

<style>
  /* å°å¹…è‡ªè¨‚ - æ¡ç”¨ Tailwind çš„ç»ç’ƒè³ªæ„Ÿå’Œæ·±è‰²æ¨¡å¼æ”¯æ´ */
  .glass {
    backdrop-filter: blur(6px);
    background: rgba(255,255,255,0.6);
  }
  .dark .glass { background: rgba(17,24,39,0.55); }
  .badge-anim { width: 92px; height: 92px; }
  /* é€²åº¦æ¢æ¼£æ¼ªæ•ˆæœ */
  .progress-wave { background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0)); }
  
  /* ------------------- éŠæˆ²åŒ–å€å¡Š CSS ------------------- */
  .water-bucket-wrapper {
      position: relative;
      width: 80px;
      height: 150px;
      border-radius: 5px 5px 20px 20px;
      overflow: hidden;
  }
  .bucket-outline {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 5px solid #a0a0a0; 
      border-top: 10px solid #888;
      border-radius: 5px 5px 20px 20px;
      box-sizing: border-box;
      pointer-events: none;
  }
  .water-level {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 0%; 
      background: linear-gradient(to top, #007bff, #4dc3ff); 
      transition: height 0.8s ease-out; 
      border-radius: 0 0 15px 15px;
  }
  .flower-garden {
      display: flex; 
      flex-wrap: wrap; 
      justify-content: center;
      align-content: flex-start;
      width: 100%;
      height: 150px; 
      overflow-y: auto; 
      padding: 5px;
      border: 1px dashed #c4d7e9; 
      background-color: #f7fff7; 
      border-radius: 10px;
      margin-bottom: 10px;
  }
  .dark .flower-garden {
      background-color: #1a202c;
      border-color: #4a5568;
  }
  .flower-unit {
      font-size: 2em; 
      margin: 3px;
      cursor: default;
      line-height: 1;
  }
  #gardenMessage {
      font-size: 0.9em;
      color: #999;
      padding-top: 50px;
  }
  /* ------------------- END éŠæˆ²åŒ–å€å¡Š CSS ------------------- */
</style>
</head>
<body class="bg-gradient-to-b from-sky-50 to-white dark:from-slate-900 dark:to-slate-800 text-slate-800 dark:text-slate-100 min-h-screen">

<div class="max-w-3xl mx-auto p-6">
  <header class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-semibold">WaterHero ğŸ’§</h1>
      <p class="text-sm text-slate-500 dark:text-slate-300">å‹™å¯¦ã€å¯åŸ·è¡Œçš„å–æ°´ç¿’æ…£ç®¡ç†ï¼ˆå«å¾½ç« ã€æé†’èˆ‡æ­·å²ï¼‰</p>
    </div>
    <div class="flex items-center gap-3">
      <button id="themeToggle" class="px-3 py-2 rounded-lg glass">ä¸»é¡Œ</button>
      <button id="notifyBtn" class="px-3 py-2 rounded-lg glass">æé†’</button>
    </div>
  </header>

  <main class="grid gap-4">
    <section class="p-4 rounded-2xl glass shadow">
      <div class="flex justify-between items-center mb-3">
        <div>
          <div class="text-sm text-slate-500 dark:text-slate-300">ä»Šæ—¥ç›®æ¨™</div>
          <div class="text-xl font-bold"><span id="goalDisplay">2000</span> <span id="unitLabel">ml</span></div>
        </div>
        <div class="text-right">
          <div class="text-sm text-slate-500 dark:text-slate-300">å·²å–</div>
          <div class="text-xl font-bold"><span id="todayTotal">0</span> <span id="unitLabel2">ml</span></div>
        </div>
      </div>

      <div class="w-full h-4 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden mb-3">
        <div id="progressBar" class="h-full bg-sky-400 dark:bg-sky-500 text-right progress-wave" style="width:0%"></div>
      </div>

      <div class="flex items-center gap-3">
        <input id="addInput" type="number" min="1" placeholder="è¼¸å…¥å–æ°´é‡ (ä¾‹å¦‚ 250)" class="flex-1 p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
        
        <div class="flex items-center gap-2 whitespace-nowrap">
            <select id="unitSelect" class="p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
              <option value="ml">ml</option>
              <option value="cup">æ¯ (250ml)</option>
            </select>
            <button id="addBtn" class="px-4 py-3 rounded-lg bg-sky-600 text-white">åŠ å…¥</button>
            <button id="undoBtn" class="px-3 py-3 rounded-lg bg-red-500 text-white" title="æ’¤éŠ·ä¸Šä¸€ç­†è¨˜éŒ„">â†¶</button>
        </div>
      </div>
    </section>

    <section class="p-4 rounded-2xl glass shadow">
        <h3 class="font-semibold text-lg mb-3">ğŸ’§ æ¾†èŠ±æŒ‘æˆ°ï¼šç´¯ç©èˆ‡æˆé•·</h3>
        <div class="flex justify-around items-end h-48">
            <div class="water-bucket-wrapper">
                <div id="waterLevel" class="water-level"></div>
                <div class="bucket-outline"></div>
            </div>
            
            <div class="w-2/3 flex flex-col items-center justify-end h-full">
                <div id="flowerGarden" class="flower-garden">
                    </div>
                <button id="waterFlowerBtn" disabled class="w-full px-4 py-2 rounded-lg bg-green-600 text-white disabled:bg-slate-400 disabled:cursor-not-allowed mt-2" title="ç´¯ç© 1000ml æ°´å¯æ¾†èŠ±">
                    ğŸ’§ æ¾†èŠ± (1000ml)
                </button>
            </div>
        </div>
    </section>

    <section class="p-4 rounded-2xl glass shadow">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-semibold">éå» 7 å¤©ç´€éŒ„</h3>
        <div class="text-sm text-slate-500 dark:text-slate-300">æŸ¥çœ‹è¶¨å‹¢ä»¥ä½œç‚ºè¡Œç‚ºèª¿æ•´ä¾æ“š</div>
      </div>
      <canvas id="weekChart" height="140"></canvas>
      <div id="historyList" class="mt-3 text-sm text-slate-700 dark:text-slate-300"></div>
    </section>

    <section class="p-4 rounded-2xl glass shadow grid gap-3">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm text-slate-500 dark:text-slate-300">æ°´ç“¶åç¨±</div>
          <input id="bottleName" class="p-2 mt-1 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="ç‚ºä½ çš„æ°´ç“¶å‘½å">
        </div>
        <div class="text-right">
          <div class="text-sm text-slate-500 dark:text-slate-300">ç­‰ç´š</div>
          <div class="text-lg font-bold" id="bottleLevel">Lv.1</div>
        </div>
      </div>

      <div class="flex items-center gap-6">
        <div id="badgeContainer" class="badge-anim"></div>
        <div>
          <div class="text-sm text-slate-500 dark:text-slate-300">é€£çºŒé”æ¨™ (streak)</div>
          <div class="text-2xl font-bold" id="streakCount">0</div>
          <div class="text-sm text-slate-500 dark:text-slate-300 mt-1" id="streakHint">é€£çºŒé”æˆæ¯æ—¥ç›®æ¨™å¯æå‡ç­‰ç´šä¸¦è§£é–å¾½ç« </div>
        </div>
      </div>

      <div class="flex gap-2">
        <button id="claimBadge" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">é ˜å–å¾½ç« ï¼ˆé”æˆæ™‚å¯é»ï¼‰</button>
        <button id="resetAll" class="px-4 py-2 rounded-lg bg-red-600 text-white">é‡è¨­æ‰€æœ‰è³‡æ–™</button>
      </div>
    </section>
    
    <section class="p-4 rounded-2xl glass shadow grid gap-3">
        <h3 class="font-semibold text-lg">ç³»çµ±è¨­å®šèˆ‡æ“ä½œ</h3>
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm text-slate-500 dark:text-slate-300">æ¯æ—¥ç›®æ¨™ (ml)</div>
          <input id="goalInput" type="number" min="100" class="p-2 mt-1 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800" value="2000">
        </div>
        <div class="text-right">
          <div class="text-sm text-slate-500 dark:text-slate-300">æé†’é–“éš”</div>
          <div class="flex gap-2 mt-1">
            <input id="reminderMinutes" type="number" min="10" value="120" class="p-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 w-24"> <div class="self-center text-sm">åˆ†é˜</div>
          </div>
        </div>
      </div>

      <div class="flex gap-2">
        <button id="saveSettings" class="px-4 py-2 rounded-lg bg-green-600 text-white">å„²å­˜è¨­å®š</button>
        <button id="resetToday" class="px-4 py-2 rounded-lg bg-amber-500 text-white">é‡è¨­ä»Šæ—¥</button>
        <button id="exportBtn" class="px-4 py-2 rounded-lg bg-slate-600 text-white">åŒ¯å‡ºè³‡æ–™</button>
      </div>
      <div class="text-sm text-slate-500 dark:text-slate-300">èªªæ˜ï¼šæé†’éœ€å…è¨±ç€è¦½å™¨é€šçŸ¥ï¼›è³‡æ–™å­˜æ–¼æœ¬æ©Ÿï¼Œä¸æœƒä¸Šå‚³ã€‚</div>
    </section>


    <footer class="text-xs text-slate-500 dark:text-slate-400 mt-4">
      èªªæ˜ï¼šæœ¬ç³»çµ±ä»¥ã€Œæœ€ä½é˜»åŠ›ç´€éŒ„ã€ç‚ºåŸå‰‡ï¼›æé†’åœ¨åˆ†é é–‹å•Ÿç‹€æ…‹ä¸‹æœ‰æ•ˆï¼›è‹¥éœ€é›¢ç·šèƒŒæ™¯æ¨æ’­ï¼Œå»ºè­°å‡ç´šç‚º PWA æˆ–ä¸²æ¥ä¼ºæœå™¨ Pushã€‚
    </footer>
  </main>
</div>

<script>
/*
  WaterHero â€” çµ‚æ¥µæ•´åˆå–®æª”æ¡ˆç‰ˆæœ¬
*/

// ----------------- utility -----------------
const LS_KEY = 'waterhero_v1';
const MILLI_PER_DAY = 24*3600*1000;
const WATER_NEEDED_FOR_FLOWER = 1000; // æ¾†èŠ±æ‰€éœ€çš„æ°´é‡ (ml)
const FINAL_FLOWER_ICON = "ğŸŒ¸";

function isoDate(d = new Date()){
  return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().split('T')[0];
}
function loadState(){
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return defaultState();
    const s = JSON.parse(raw);
    return {...defaultState(), ...s};
  } catch(e) { console.error(e); return defaultState(); }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function defaultState(){
  return {
    settings: { goal: 2000, unit: 'ml', reminderMinutes: 120, theme: 'light' },
    data: {},
    meta: { 
        bottleName: '', 
        streak: 0, 
        lastAchieved: null, 
        level: 1, 
        badges: [], 
        dailyIntakes: {},
        bucketAmount: 0,
        flowerGarden: []
    }
  };
}

// ----------------- app state -----------------
let state = loadState();
let canUndo = false; 

// ----------------- DOM refs -----------------
const todayKey = () => isoDate();
const goalDisplay = document.getElementById('goalDisplay');
const todayTotalEl = document.getElementById('todayTotal');
const progressBar = document.getElementById('progressBar');
const addInput = document.getElementById('addInput');
const addBtn = document.getElementById('addBtn');
const undoBtn = document.getElementById('undoBtn');
const unitSelect = document.getElementById('unitSelect');
const unitLabel = document.getElementById('unitLabel');
const unitLabel2 = document.getElementById('unitLabel2');
const goalInput = document.getElementById('goalInput');
const saveSettings = document.getElementById('saveSettings');
const resetTodayBtn = document.getElementById('resetToday');
const weekChartCtx = document.getElementById('weekChart');
const historyList = document.getElementById('historyList');
const reminderMinutesInput = document.getElementById('reminderMinutes');
// const notifyBtn = document.getElementById('notifyBtn'); // ç§»åˆ° onload ç¯„åœ
// const themeToggle = document.getElementById('themeToggle'); // ç§»åˆ° onload ç¯„åœ
const exportBtn = document.getElementById('exportBtn');


const bottleNameInput = document.getElementById('bottleName');
const bottleLevelEl = document.getElementById('bottleLevel');
const streakCountEl = document.getElementById('streakCount');
const badgeContainer = document.getElementById('badgeContainer');
const claimBadgeBtn = document.getElementById('claimBadge');
const resetAllBtn = document.getElementById('resetAll');

// éŠæˆ²åŒ– DOM å¼•ç”¨
const waterLevelDisplay = document.getElementById('waterLevel');
const waterFlowerBtn = document.getElementById('waterFlowerBtn');
const flowerGardenDisplay = document.getElementById('flowerGarden'); 

// ----------------- initialization -----------------
function init(){
  // æª¢æŸ¥ä¸¦åˆå§‹åŒ–éŠæˆ²åŒ–æ•¸æ“š
  if (typeof state.meta.bucketAmount === 'undefined') state.meta.bucketAmount = 0;
  if (typeof state.meta.flowerGarden === 'undefined') state.meta.flowerGarden = [];

  // apply settings UI
  goalInput.value = state.settings.goal;
  unitSelect.value = state.settings.unit;
  reminderMinutesInput.value = state.settings.reminderMinutes;
  bottleNameInput.value = state.meta.bottleName || '';
  applyTheme(state.settings.theme);

  // render today
  if (!state.data[todayKey()]) state.data[todayKey()] = 0;
  if (!state.meta.dailyIntakes[todayKey()]) state.meta.dailyIntakes[todayKey()] = [];
  render();

  // events
  addBtn.addEventListener('click', onAdd);
  addInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') onAdd(); });
  saveSettings.addEventListener('click', onSaveSettings);
  resetTodayBtn.addEventListener('click', onResetToday);
  unitSelect.addEventListener('change', onUnitChange);
  exportBtn.addEventListener('click', onExport);
  bottleNameInput.addEventListener('change', onBottleNameChange);
  claimBadgeBtn.addEventListener('click', onClaimBadge);
  resetAllBtn.addEventListener('click', onResetAll);
  undoBtn.addEventListener('click', onUndo); 
  waterFlowerBtn.addEventListener('click', onWaterFlower); 

  startReminderTimerIfNeeded();
  initBadgeAnimation();
  initChart();
  updateChart();
}

function applyTheme(t){
  if (t === 'dark') document.documentElement.classList.add('dark');
  else document.documentElement.classList.remove('dark');
  state.settings.theme = t;
  saveState();
}

// ----------------- core functions -----------------
function getTodayTotal(){
  const todayIntakes = state.meta.dailyIntakes[todayKey()] || [];
  return todayIntakes.reduce((sum, amount) => sum + amount, 0);
}

function setTodayTotal(v, rawAmount){
  if (!state.meta.dailyIntakes[todayKey()]) state.meta.dailyIntakes[todayKey()] = [];
  state.meta.dailyIntakes[todayKey()].push(rawAmount);

  state.data[todayKey()] = v;
  state.meta.bucketAmount += rawAmount;

  saveState();
}

function onAdd(){
  const raw = parseFloat(addInput.value);
  if (!raw || raw <= 0) { alert('è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æ•¸å­—'); return; }
  let addMl = raw;
  if (unitSelect.value === 'cup') addMl = raw * 250;
  
  const prevTotal = getTodayTotal();
  const newTotal = prevTotal + addMl;
  
  setTodayTotal(newTotal, addMl);
  addInput.value = '';
  
  canUndo = true; 

  render();
  
  if (prevTotal < state.settings.goal && newTotal >= state.settings.goal){
    onAchieveToday();
  }
}

function onUndo(){
  if (!canUndo) {
    alert("åªèƒ½æ’¤éŠ·ä¸Šä¸€æ¬¡å–®ç­†å–æ°´è¨˜éŒ„ã€‚è«‹å…ˆè¨˜éŒ„æ–°çš„å–æ°´é‡æ‰èƒ½å†æ¬¡æ’¤éŠ·ã€‚");
    return;
  }
  
  const todayIntakes = state.meta.dailyIntakes[todayKey()];
  if (!todayIntakes || todayIntakes.length === 0) {
    alert("ä»Šæ—¥å°šç„¡è¨˜éŒ„å¯ä»¥æ’¤éŠ·ï¼");
    canUndo = false;
    return;
  }

  const lastAmount = todayIntakes.pop();

  const newTotal = getTodayTotal();
  state.data[todayKey()] = newTotal;
  
  state.meta.bucketAmount = Math.max(0, state.meta.bucketAmount - lastAmount);

  canUndo = false; 
  saveState();
  render();

  alert(`å·²æˆåŠŸæ’¤éŠ· ${lastAmount} ml çš„è¨˜éŒ„ï¼`);
}

function onWaterFlower(){
    if (state.meta.bucketAmount < WATER_NEEDED_FOR_FLOWER) {
        alert("æ°´æ¡¶æ°´é‡ä¸è¶³ï¼Œè«‹ç¹¼çºŒå–æ°´ï¼");
        return;
    }

    state.meta.bucketAmount -= WATER_NEEDED_FOR_FLOWER;

    const newFlower = {
        date: todayKey(),
        timestamp: Date.now()
    };
    state.meta.flowerGarden.push(newFlower);
    
    saveState();
    render();

    alert("æ¾†èŠ±æˆåŠŸï¼æ­å–œæ‚¨é•·æˆäº†ä¸€æœµæ–°çš„èŠ±ï¼ğŸŒ¸");
}


function onSaveSettings(){
  const g = parseInt(goalInput.value) || 2000;
  const rm = parseInt(reminderMinutesInput.value) || 120;
  state.settings.goal = Math.max(100, g);
  state.settings.reminderMinutes = Math.max(10, rm);
  state.settings.unit = unitSelect.value;
  saveState();
  render();
  startReminderTimerIfNeeded(true);
  alert('è¨­å®šå·²å„²å­˜');
}

function onResetToday(){
  if (!confirm('ç¢ºèªè¦é‡è¨­ä»Šæ—¥å–æ°´ç´€éŒ„ï¼Ÿæ­¤å‹•ä½œä¸å¯é‚„åŸã€‚')) return;
  
  state.data[todayKey()] = 0;
  state.meta.dailyIntakes[todayKey()] = [];
  
  canUndo = false; 
  saveState();
  render();
}

function onResetAll(){
  if (!confirm('é‡è¨­æ‰€æœ‰è³‡æ–™ï¼ˆå« streakã€å¾½ç« ã€æ­·å²ã€èŠ±åœ’ï¼‰ï¼Ÿç¢ºå®šè«‹è¼¸å…¥ yes')) return;
  const token = prompt('è¼¸å…¥ "yes" ä»¥ç¢ºèªé‡è¨­');
  if (token !== 'yes') return;
  state = defaultState();
  saveState();
  location.reload();
}

function onUnitChange(){
  if (unitSelect.value === 'cup') { unitLabel.textContent = 'æ¯'; unitLabel2.textContent = 'æ¯'; }
  else { unitLabel.textContent = 'ml'; unitLabel2.textContent = 'ml'; }
  state.settings.unit = unitSelect.value;
  saveState();
  render();
}

// ----------------- achievement / streak -----------------
function onAchieveToday(){
  const yesterday = isoDate(new Date(Date.now() - MILLI_PER_DAY));
  const yesterdayReached = (state.data[yesterday] || 0) >= state.settings.goal;
  
  if (yesterdayReached && state.meta.lastAchieved === yesterday) {
    state.meta.streak = (state.meta.streak || 0) + 1;
  } else {
    state.meta.streak = 1;
  }
  state.meta.lastAchieved = todayKey();
  
  updateBottleLevel(); 
  saveState();

  showNotification('ä»Šæ—¥ç›®æ¨™é”æˆ ğŸ‰', `å·²é”æˆä»Šæ—¥ç›®æ¨™ ${state.settings.goal} ml`);
  playBadgeUnlock();
}

function updateBottleLevel(){
  const s = state.meta.streak || 0;
  let lvl = 1;
  if (s >= 30) lvl = 5;
  else if (s >= 14) lvl = 4;
  else if (s >= 7) lvl = 3;
  else if (s >= 3) lvl = 2;
  state.meta.level = lvl;
  
  const badge = `Lv${lvl}-streak-${s}`;
  if (!state.meta.badges.includes(badge)) state.meta.badges.push(badge);
  saveState();
}

function onClaimBadge(){
  if (getTodayTotal() < state.settings.goal) {
    alert('å°šæœªé”æˆä»Šæ—¥ç›®æ¨™ï¼Œç„¡æ³•é ˜å–å¾½ç« ');
    return;
  }
  const badge = `achieve-${todayKey()}`;
  if (!state.meta.badges.includes(badge)) {
    state.meta.badges.push(badge);
    saveState();
    alert('å¾½ç« å·²é ˜å–ï¼å·²åŠ å…¥å€‹äººå¾½ç« ç‰†ã€‚');
  } else {
    alert('æœ¬æ—¥å¾½ç« å·²é ˜å–ã€‚');
  }
  render();
}

// ----------------- notifications / reminders -----------------
let reminderTimer = null;
function startReminderTimerIfNeeded(force=false){
  if (reminderTimer && !force) return;
  if (reminderTimer) { clearInterval(reminderTimer); reminderTimer = null; }
  const mins = parseInt(state.settings.reminderMinutes) || 120;
  reminderTimer = setInterval(()=> {
    if (getTodayTotal() < state.settings.goal) {
      showNotification('å–æ°´æé†’', `å°šæœªé”æˆä»Šæ—¥ç›®æ¨™ ${state.settings.goal} mlï¼Œä¾†ä¸€æ¯æ°´å§`);
    }
  }, mins*60*1000);
}

function onToggleTheme(){
  const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
  applyTheme(next);
}

async function onRequestNotify(){
  if (!('Notification' in window)) { alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Notifications'); return; }
  const perm = await Notification.requestPermission();
  if (perm === 'granted') {
    alert('å·²å–å¾—é€šçŸ¥æ¬Šé™ï¼ˆæé†’å°‡åœ¨æœ¬åˆ†é é–‹å•Ÿæ™‚ç”Ÿæ•ˆï¼›å¦‚éœ€èƒŒæ™¯æé†’è«‹è€ƒæ…® PWA/Server Pushï¼‰');
    showNotification('æé†’å·²å•Ÿç”¨', 'WaterHero å·²å•Ÿç”¨å–æ°´æé†’ï¼ˆåªåœ¨åˆ†é é–‹å•Ÿæ™‚æœ‰æ•ˆï¼‰');
  } else {
    alert('æœªå–å¾—é€šçŸ¥æ¬Šé™ï¼Œç„¡æ³•å•Ÿç”¨æé†’');
  }
}

function showNotification(title, body){
  if (!('Notification' in window)) return;
  if (Notification.permission !== 'granted') return;
  try {
    const n = new Notification(title, { body, icon: null });
    n.onclick = () => window.focus();
  } catch(e) { console.warn('é€šçŸ¥å¤±æ•—', e); }
}

// ----------------- chart / history -----------------
let weekChart = null;
function initChart(){
  const cfg = {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'æ¯æ—¥ç¸½é‡ (ml)', data: [], borderRadius: 8, barThickness: 18 }]},
    options: {
      responsive: true,
      scales: {
        x: { grid: { display: false } },
        y: { beginAtZero: true }
      },
      plugins: { legend: { display: false } }
    }
  };
  weekChart = new Chart(weekChartCtx, cfg);
}

function updateChart(){
  const labels = [];
  const dataPoints = [];
  for (let i=6; i>=0; i--){
    const d = new Date(Date.now() - i*MILLI_PER_DAY);
    const key = isoDate(d);
    labels.push(key.slice(5)); 
    dataPoints.push(state.data[key] || 0);
  }
  weekChart.data.labels = labels;
  weekChart.data.datasets[0].data = dataPoints;
  weekChart.update();
  renderHistoryList();
}

function renderHistoryList(){
  let html = '';
  const keys = Object.keys(state.meta.dailyIntakes)
                     .filter(k => state.meta.dailyIntakes[k].length > 0)
                     .sort()
                     .slice(-14)
                     .reverse();

  if (keys.length === 0) {
    html = '<div class="text-sm text-slate-500">å°šç„¡ç´€éŒ„</div>';
  } else {
    keys.forEach(k => {
      const v = state.data[k] || 0;
      const intakes = state.meta.dailyIntakes[k].join(' + ');
      html += `<div class="flex flex-col py-1 border-b border-slate-100 dark:border-slate-700">
                 <div class="flex justify-between font-semibold"><span>${k}</span><span>${v} ml</span></div>
                 <div class="text-xs text-slate-500 dark:text-slate-400">è©³æƒ…: ${intakes} ml</div>
               </div>`;
    });
  }
  historyList.innerHTML = html;
}

// ----------------- render UI -----------------
function render(){
  // æª¢æŸ¥ä»Šæ—¥å–®ç­†è¨˜éŒ„æ˜¯å¦å­˜åœ¨
  if (!state.data[todayKey()]) state.data[todayKey()] = 0;
  if (!state.meta.dailyIntakes[todayKey()]) state.meta.dailyIntakes[todayKey()] = [];

  // WaterHero UI
  goalDisplay.textContent = state.settings.goal;
  todayTotalEl.textContent = Math.round(getTodayTotal());
  const pct = Math.min(100, Math.round(getTodayTotal() / state.settings.goal * 100));
  progressBar.style.width = pct + '%';
  bottleLevelEl.textContent = `Lv.${(state.meta.level || 1)}`;
  streakCountEl.textContent = state.meta.streak || 0;
  bottleNameInput.value = state.meta.bottleName || '';
  updateChart();

  // éŠæˆ²åŒ– UI
  const maxCapacity = WATER_NEEDED_FOR_FLOWER * 2; 
  let levelPercentage = Math.min((state.meta.bucketAmount / maxCapacity) * 100, 100);
  waterLevelDisplay.style.height = `${levelPercentage}%`;

  if (state.meta.bucketAmount >= WATER_NEEDED_FOR_FLOWER) {
      waterFlowerBtn.disabled = false;
      waterFlowerBtn.title = `é»æ“Šæ¾†èŠ± (${WATER_NEEDED_FOR_FLOWER} ml)`;
  } else {
      waterFlowerBtn.disabled = true;
      const missing = WATER_NEEDED_FOR_FLOWER - state.meta.bucketAmount;
      waterFlowerBtn.title = `é‚„éœ€è¦ ${missing} ml æ‰èƒ½æ¾†èŠ±`;
  }
  
  renderGarden();
  saveState();
}

function renderGarden() {
    let html = '';
    const garden = state.meta.flowerGarden;

    if (garden.length === 0) {
        html = '<p id="gardenMessage">ä½ çš„èŠ±åœ’é‚„ç©ºç©ºçš„ï¼Œå¿«ä¾†æ¾†æ°´å§ï¼</p>';
    } else {
        garden.forEach(() => {
            html += `<span class="flower-unit">${FINAL_FLOWER_ICON}</span>`;
        });
    }
    flowerGardenDisplay.innerHTML = html;
}

// ----------------- export / import -----------------
function onExport(){
  const dataStr = JSON.stringify(state, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `waterhero_export_${isoDate()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// ----------------- badge animation (lottie) -----------------
let lottiePlayer = null;
function initBadgeAnimation(){
  const sampleAnim = {
    "v":"5.5.7","fr":30,"ip":0,"op":60,"w":200,"h":200,"nm":"drop","ddd":0,"assets":[],"layers":[
      {"ddd":0,"ind":1,"ty":4,"nm":"drop","sr":1,"ks":{"o":{"k":100},"r":{"k":0},"p":{"k":[100,100,0]},"a":{"k":[0,0,0]},"s":{"k":[100,100,100]}},"shapes":[
        {"ty":"gr","it":[{"ind":0,"ty":"sh","ks":{"k":{"i":[[0,0]],"o":[[0,0]],"v":[[0,-40],[24,-10],[12,30],[-12,30],[-24,-10]],"c":true}},"nm":"path"},{"ty":"fl","c":{"k":[0.13,0.63,0.95,1]},"o":{"k":100}}],"nm":"dropShape"}]
    }]
  };
  try {
    lottiePlayer = lottie.loadAnimation({
      container: badgeContainer,
      renderer: 'svg',
      loop: false,
      autoplay: false,
      animationData: sampleAnim
    });
  } catch(e){
    console.warn('lottie init fail', e);
  }
}

function playBadgeUnlock(){
  if (lottiePlayer) {
    try { lottiePlayer.goToAndPlay(0,true); } catch(e){ console.warn(e); }
  }
}

// ----------------- theme toggle -----------------
// ç§»åˆ°é€™è£¡ä¾†ç¢ºä¿èƒ½åœ¨ window.onload è£¡è¢«ç¶å®š
// ----------------- init + first render -----------------

// ä½¿ç”¨ window.onload ç¢ºä¿æ‰€æœ‰ DOM å…ƒç´ å’Œå¤–éƒ¨ CDN ç¨‹å¼åº«éƒ½å®Œå…¨è¼‰å…¥å¾Œæ‰å•Ÿå‹•
window.onload = () => {
    // ç¨ç«‹ç²å–å’Œç¶å®šé€™å…©å€‹å®¹æ˜“å¤±æ•—çš„æŒ‰éˆ•
    const themeToggle = document.getElementById('themeToggle');
    const notifyBtn = document.getElementById('notifyBtn');

    if (themeToggle) themeToggle.addEventListener('click', onToggleTheme);
    if (notifyBtn) notifyBtn.addEventListener('click', onRequestNotify);
    
    // å•Ÿå‹•ä¸»ç¨‹å¼
    init();
};
</script>
</body>
</html>
